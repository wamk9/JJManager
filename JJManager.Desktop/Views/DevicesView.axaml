<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:JJManager.Desktop.ViewModels"
             xmlns:converters="using:JJManager.Desktop.Converters"
             xmlns:mi="using:Material.Icons.Avalonia"
             x:Class="JJManager.Desktop.Views.DevicesView"
             x:DataType="vm:DevicesViewModel">

    <UserControl.Resources>
        <converters:BoolToStringConverter x:Key="BoolToString"/>
        <converters:BoolToColorConverter x:Key="BoolToColor"/>
        <converters:StringToMaterialIconKindConverter x:Key="StringToMaterialIconKind"/>
        <converters:StringToImageConverter x:Key="StringToImage"/>
        <converters:InverseBoolConverter x:Key="InverseBool"/>
    </UserControl.Resources>

    <Grid RowDefinitions="Auto,*" Margin="24">
		
        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,16">
            <TextBlock Text="{DynamicResource Devices_Title}" FontSize="28" FontWeight="Bold"/>
            <TextBlock Text="{DynamicResource Devices_Subtitle}"
                       Opacity="0.7"
                       Margin="0,4,0,0"/>
        </StackPanel>

        <!-- Device List -->
        <ScrollViewer Grid.Row="1">
            <ItemsControl ItemsSource="{Binding Devices}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>

                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="vm:DeviceItemViewModel">
                        <Border Background="{DynamicResource CardBackgroundBrush}"
                                CornerRadius="12"
                                Padding="16"
                                Margin="0,0,16,16"
                                Width="200">
                            <StackPanel Spacing="12">
                                <!-- Device Icon with Connection Badge -->
                                <Grid HorizontalAlignment="Center">
                                    <!-- Device Icon Background -->
									<Border Background="{DynamicResource AccentBrush}"
											CornerRadius="12"
											Width="80"
											Height="80">

										<Grid>
											<!-- Imagem do dispositivo (quando HasImage = true) -->
											<Image Source="{Binding ImageResourcePath, Converter={StaticResource StringToImage}}"
												   Width="60"
												   Height="60"
												   Stretch="Uniform"
												   HorizontalAlignment="Center"
												   VerticalAlignment="Center"
												   IsVisible="{Binding HasImage}"/>

											<!-- Placeholder texto (quando HasImage = false) -->
											<TextBlock Text="{Binding DeviceInitials}"
													   FontSize="24"
													   FontWeight="Bold"
													   Foreground="White"
													   HorizontalAlignment="Center"
													   VerticalAlignment="Center"
													   IsVisible="{Binding !HasImage}"/>
										</Grid>
									</Border>

									<!-- Connection Status Badge -->
                                    <Border CornerRadius="8"
                                            Padding="6,3"
                                            HorizontalAlignment="Right"
                                            VerticalAlignment="Top"
                                            Margin="0,-6,-6,0">
                                        <Border.Background>
                                            <SolidColorBrush Color="{Binding IsConnected, Converter={StaticResource BoolToColor}, ConverterParameter='SuccessColor,NeutralColor'}"/>
                                        </Border.Background>
                                        <StackPanel Orientation="Horizontal" Spacing="3">
                                            <Ellipse Width="5" Height="5" Fill="White"/>
                                            <TextBlock Text="{Binding IsConnected, Converter={StaticResource BoolToString}, ConverterParameter='ON,OFF'}"
                                                       Foreground="White"
                                                       FontSize="8"
                                                       FontWeight="Bold"/>
                                        </StackPanel>
                                    </Border>
                                </Grid>

                                <!-- Device Name -->
                                <TextBlock Text="{Binding ProductName}"
                                           FontWeight="SemiBold"
                                           FontSize="13"
                                           TextAlignment="Center"
                                           TextWrapping="Wrap"
                                           TextTrimming="CharacterEllipsis"
                                           MaxLines="2"
                                           HorizontalAlignment="Stretch"/>

                                <!-- Firmware Version -->
                                <TextBlock Text="{Binding FirmwareVersion, StringFormat='FW: {0}'}"
                                           Opacity="0.6"
                                           FontSize="10"
                                           TextAlignment="Center"
                                           HorizontalAlignment="Stretch"/>

                                <!-- Action Button -->
                                <Button Command="{Binding ConnectCommand}"
                                        IsVisible="{Binding !IsConnected}"
                                        IsEnabled="{Binding !IsConnecting}"
                                        Classes="accent"
                                        HorizontalAlignment="Stretch"
                                        HorizontalContentAlignment="Center">
                                    <TextBlock Text="{Binding IsConnecting, Converter={StaticResource BoolToString}, ConverterParameter='Conectando...,Conectar'}"/>
                                </Button>
                                
                                <Button Command="{Binding DisconnectCommand}"
                                        IsVisible="{Binding IsConnected}"
                                        HorizontalAlignment="Stretch"
                                        HorizontalContentAlignment="Center">
                                    <TextBlock Text="Desconectar"/>
                                </Button>

                                <Button Command="{Binding OpenSettingsCommand}"
                                        HorizontalAlignment="Stretch"
                                        HorizontalContentAlignment="Center">
                                    <TextBlock Text="Configurar"/>
                                </Button>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- Empty State -->
        <StackPanel Grid.Row="1"
                    IsVisible="{Binding !Devices.Count}"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Spacing="16">
            <mi:MaterialIcon Kind="DesktopClassic" Width="64" Height="64"
                             Opacity="0.5"
                             HorizontalAlignment="Center"/>
            <TextBlock Text="{DynamicResource Devices_Empty_Title}"
                       FontSize="18"
                       Opacity="0.7"
                       HorizontalAlignment="Center"/>
            <TextBlock Text="{DynamicResource Devices_Empty_Subtitle}"
                       FontSize="12"
                       Opacity="0.5"
                       HorizontalAlignment="Center"/>
        </StackPanel>
    </Grid>
</UserControl>
